<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Hipergeom√©trica</title>
    <link rel="stylesheet" href="/mtg_tools/styles/main_style.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="/mtg_tools/Ferramentas_MTG.html">üè† Menu Principal</a></li>
            <li><a href="/mtg_tools/Deck_Tracker_V3.html">üìä Deck Stats Tracker</a></li>
            <li><a href="/mtg_tools/Calculadora_MTG.html" class="active">üßÆ Calculadora de Probabilidade</a></li>
            <li><a href="/mtg_tools/Mtgo_Results.html">üèÜ MTGO Results</a></li>
            <li><a href="/mtg_tools/Matchup_Matrix.html">üìà Matchup Matrix</a></li>
        </ul>
    </nav>
    <div class="container">
        <header>
            <h1>Calculadora Hipergeom√©trica</h1>
            <h2>Probabilidade para Magic: The Gathering</h2>
        </header>
        
        <form id="hypergeometricForm">
            <label for="popSize">Cartas no deck:</label>
            <input style="text-align: center;" type="number" id="popSize" name="popSize" required><br>

            <label for="sampleSize">Quantos draws:</label>
            <input style="text-align: center;" type="number" id="sampleSize" name="sampleSize" required><br>

            <label for="successesInPop">Quantos Outs:</label>
            <input style="text-align: center;" style="text-align: center;" type="number" id="successesInPop" name="successesInPop" required><br>

            <label for="successesNeeded">Sucessos necess√°rios:</label>
            <input style="text-align: center;" type="number" id="successesNeeded" name="successesNeeded" required><br>

            <button type="button" onclick="runCalculations()">Calcular</button>
        </form>

        <div id="results" class="success">
            </div>

        <div id="status" class="loading">Pronto para o c√°lculo...</div>

    </div>

    <script>
        // Fun√ß√µes de C√°lculo (Mantidas do original)
        function fat(x) {
            let soma = 0;
            for (let i = 0; i < x; i++) {
                soma += Math.log(x - i);
            }
            return soma;
        }

        function escolhe(x, y) {
            if (y < 0 || y > x) {
                return -Infinity;
            }
            return fat(x) - fat(y) - fat(x - y);
        }

        function hypergeometric_log_prob(N, n, K, k) {
            if (n - k > N - K) {
                return -Infinity; 
            }
            const log_comb_K_k = escolhe(K, k);
            const log_comb_NK_nk = escolhe(N - K, n - k);
            const log_comb_N_n = escolhe(N, n);
            return log_comb_K_k + log_comb_NK_nk - log_comb_N_n;
        }

        function runCalculations() {
            const P = parseInt(document.getElementById('popSize').value);
            const A = parseInt(document.getElementById('sampleSize').value);
            const S = parseInt(document.getElementById('successesInPop').value);
            const N = parseInt(document.getElementById('successesNeeded').value);
            
            const statusElement = document.getElementById('status');
            const resultsElement = document.getElementById('results');
            
            // Valida√ß√µes b√°sicas
            if (isNaN(P) || isNaN(A) || isNaN(S) || isNaN(N) || P <= 0 || A <= 0 || S < 0 || N < 0 || A > P || S > P) {
                statusElement.textContent = 'Erro: Verifique se todos os campos est√£o preenchidos corretamente e se os valores s√£o v√°lidos (Amostra e Outs n√£o podem ser maiores que o Deck).';
                statusElement.className = 'error';
                resultsElement.style.display = 'none';
                return;
            }

            statusElement.textContent = 'Calculando...';
            statusElement.className = 'loading';
            resultsElement.style.display = 'none';


            let totalLogSum = -Infinity;
            const maxSuccesses = Math.min(A, S); // O n√∫mero m√°ximo de sucessos que voc√™ pode tirar
            const minSuccesses = N;
            
            // Array para guardar log-probabilidades exatas (para mostrar o 'exatamente N')
            const Probabilidade_exata = new Array(maxSuccesses + 1).fill(-Infinity);

            // Calcula a probabilidade de ter 'i' sucessos, onde i vai de minSuccesses at√© maxSuccesses
            for (let i = 0; i <= maxSuccesses; i++) {
                // A f√≥rmula √© hypergeometric_log_prob(N total, n draws, K outs, k successes)
                const log_prob = hypergeometric_log_prob(P, A, S, i);
                Probabilidade_exata[i] = log_prob;
                
                // Acumula a soma das probabilidades de Pelo Menos N
                if (i >= N) {
                    // Log-sum-exp para somar log-probabilidades (mais preciso)
                    if (totalLogSum === -Infinity) {
                         totalLogSum = log_prob;
                     } else {
                         totalLogSum = totalLogSum + Math.log(1 + Math.exp(log_prob - totalLogSum));
                     }
                }
            }

            const prob_pelo_menos_N = Math.exp(totalLogSum);
            // Verifica se N est√° dentro do range de Probabilidade_exata
            const prob_exata_N = (N <= maxSuccesses && N >= 0) ? Math.exp(Probabilidade_exata[N]) : 0;
            
            let html_temp = `<h4>Resultado do C√°lculo</h4>`;
            
            html_temp += `<p>CHANCE DE PELO MENOS ${N} OUTS: <strong>${(100 * prob_pelo_menos_N).toFixed(5)}%</strong></p>`;
            
            if (prob_exata_N > 0) {
                html_temp += `<p>CHANCE DE EXATAMENTE ${N} OUTS: <strong>${(100 * prob_exata_N).toFixed(5)}%</strong></p>`;
            } else {
                html_temp += `<p>CHANCE DE EXATAMENTE ${N} OUTS: <strong>0.00000%</strong> (Imposs√≠vel com esses dados)</p>`;
            }

            resultsElement.innerHTML = html_temp;
            resultsElement.style.display = 'block';

            statusElement.textContent = 'C√°lculo Conclu√≠do.';
            statusElement.className = 'success';
        }
    </script>
</body>
</html>
