<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTGO Results Tracker</title>
    <link rel="stylesheet" href="/mtg_tools/styles/main_style.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="/mtg_tools/Ferramentas_MTG.html">üè† Menu Principal</a></li>
            <li><a href="/mtg_tools/Deck_Tracker_V3.html">üìä Deck Stats Tracker</a></li>
            <li><a href="/mtg_tools/Calculadora_MTG.html">üßÆ Calculadora de Probabilidade</a></li>
            <li><a href="/mtg_tools/Mtgo_Results.html" class="active">üèÜ MTGO Results</a></li>
        </ul>
    </nav>
    <div class="container">
        <header>
            <h1>üèÜ MTGO Results Tracker</h1>
            <h2>Rastreamento de Resultados de Jogadores MTGO</h2>
        </header>
        <section class="search-section">
            <label for="username-input">Digite o username do MTGO:</label>
            <div class="input-group">
                <input type="text" id="username-input" placeholder="Ex: claudio0907">
                <button onclick="searchPlayer()">Buscar Resultados</button>
            </div>
            <p style="font-size: 0.9em; color: #b8b8b8; margin-top: 10px;">
                ‚ÑπÔ∏è Os dados s√£o extra√≠dos diretamente do MTGGoldfish
            </p>
        </section>

        <div id="status" class="loading" style="display: none;">Buscando dados...</div>

        <section id="stats-overview" style="display: none;">
            <h2>üìä Estat√≠sticas de <span id="player-name"></span></h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-events">0</div>
                    <div class="stat-label">Total de Eventos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-top8">0</div>
                    <div class="stat-label">Top 8</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-top16">0</div>
                    <div class="stat-label">Top 16</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-5-0">0</div>
                    <div class="stat-label">5-0 em Ligas</div>
                </div>
            </div>
        </section>

        <section id="recent-results" style="display: none;">
            <h2>üéØ √öltimos Resultados</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Evento</th>
                        <th>Deck</th>
                        <th>Resultado</th>
                        <th>Formato</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                </tbody>
            </table>
        </section>

        <section id="deck-stats" style="display: none;">
            <h2>üÉè Decks Mais Usados</h2>
            <div id="deck-list"></div>
        </section>
    </div>

<script>
    let playerData = null;

    async function searchPlayer() {
        const username = document.getElementById('username-input').value.trim();

        if (!username) {
            showStatus('Digite um username v√°lido!', 'error');
            return;
        }

        showStatus('Buscando dados do jogador...', 'loading');
        hideResults();

        // Reiniciar playerData
        playerData = {
            username: username,
            totalEvents: 0,
            top8: 0,
            top16: 0,
            top32: 0,
            fiveO: 0,
            recentResults: [],
            deckStats: {},
            formatStats: {}
        };
        
        try {
            await paginateAndFetch(username, 1);
            
            if (playerData.totalEvents === 0) {
                throw new Error('Nenhum resultado encontrado para este jogador');
            }
            
            // Limitar aos 20 resultados mais recentes para exibi√ß√£o (ap√≥s todas as p√°ginas)
            playerData.recentResults = playerData.recentResults.slice(0, 20);

            displayResults();
            showStatus(`‚úÖ ${playerData.totalEvents} resultados encontrados para ${playerData.username} em todas as p√°ginas!`, 'success');

        } catch (error) {
            // Se o erro for '404' ou 'not found' da primeira p√°gina, mostra a mensagem de erro
            if (error.message.includes('Jogador n√£o encontrado') || error.message.includes('Nenhum resultado')) {
                 showStatus(`‚ùå Erro: ${error.message}. Verifique se o username est√° correto.`, 'error');
            } else {
                 showStatus(`‚ùå Erro durante a busca: ${error.message}.`, 'error');
            }
            
            // Link alternativo
            const resultsBody = document.getElementById('results-body');
            document.getElementById('recent-results').style.display = 'block';
            resultsBody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px;">
                        <p style="margin-bottom: 15px;">‚ö†Ô∏è N√£o foi poss√≠vel acessar automaticamente os dados.</p>
                        <a href="https://www.mtggoldfish.com/player/${username}" 
                           target="_blank" 
                           class="btn btn-primary"
                           style="display: inline-block;">
                            Abrir Perfil no MTGGoldfish
                        </a>
                    </td>
                </tr>
            `;
        }
    }

    // NOVA FUN√á√ÉO: Pagina√ß√£o e Busca
    async function paginateAndFetch(username, page) {
        showStatus(`Buscando dados da p√°gina ${page}...`, 'loading');

        const url = `https://www.mtggoldfish.com/player/${username}${page > 1 ? `?page=${page}` : ''}`;
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
        
        try {
            const response = await fetch(proxyUrl);
            
            // Se a resposta n√£o for OK (ex: 404), parar a pagina√ß√£o
            if (!response.ok) {
                // Se for a primeira p√°gina e falhar, lan√ßa erro para ser tratado como "Jogador n√£o encontrado"
                if (page === 1) {
                    throw new Error('Jogador n√£o encontrado');
                }
                // Para outras p√°ginas, apenas para a recurs√£o (assume-se que a pagina√ß√£o terminou)
                console.log(`Pagina√ß√£o conclu√≠da ou erro na p√°gina ${page}. Status: ${response.status}`);
                return; 
            }
            
            const html = await response.text();
            
            // Verifica se h√° resultados na p√°gina (evita p√°ginas vazias ou com erro suave)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const rows = doc.querySelectorAll('table tbody tr');

            if (rows.length === 0) {
                console.log(`Nenhum resultado encontrado na p√°gina ${page}. Parando pagina√ß√£o.`);
                return; // Para a recurs√£o
            }

            // Processa os resultados da p√°gina atual, mas n√£o redefine o playerData
            parsePageResults(doc);

            // Chama a pr√≥xima p√°gina recursivamente
            await paginateAndFetch(username, page + 1);

        } catch (error) {
            // Lan√ßa o erro apenas se for a primeira p√°gina, sen√£o para a recurs√£o
            if (page === 1) {
                throw error; 
            }
            console.log(`Erro ao buscar a p√°gina ${page}: ${error.message}. Parando pagina√ß√£o.`);
        }
    }

        // FUN√á√ÉO MODIFICADA: Renomeada para processar apenas uma p√°gina
        function parsePageResults(doc) {
            // Buscar todas as linhas da tabela de resultados
            const rows = doc.querySelectorAll('table tbody tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 5) return;

                // Extrair dados de cada coluna
                const date = cells[0]?.textContent.trim() || '';
                const eventName = cells[1]?.textContent.trim() || '';
                const format = cells[2]?.textContent.trim() || '';
                const deckName = cells[3]?.textContent.trim() || '';
                const finish = cells[4]?.textContent.trim() || ''; // Coloca√ß√£o original

                // Adicionar aos resultados (apenas se houver data e evento)
                if (date && eventName) {
                    playerData.recentResults.push({
                        date: date,
                        event: eventName,
                        format: format,
                        deck: deckName,
                        placement: finish
                    });

                    playerData.totalEvents++;

                    // --- L√ìGICA DE CONTAGEM CORRIGIDA E EXCLUSIVA ---

                    const finishLower = finish.toLowerCase();
                    const placementNum = parseInt(finish); // Tenta obter o n√∫mero (Ex: '12th' -> 12)
                    
                    // 1. 5-0 em Ligas (Prioridade m√°xima, usa regex para incluir "5-0" e "5 - 0")
                    if (/\b5\s*-\s*0\b/.test(finishLower)) {
                        playerData.fiveO++;
                    } 
                    
                    // 2. Coloca√ß√µes num√©ricas (Verifica√ß√£o com if/else if para exclusividade)
                    else if (!isNaN(placementNum) && placementNum > 0) {
                        
                        // Posi√ß√£o 1-8: Conta SOMENTE para Top 8
                        if (placementNum <= 8) {
                            playerData.top8++;
                        }
                        
                        // Posi√ß√£o 9-16: Conta SOMENTE para Top 16 (Se n√£o for Top 8)
                        else if (placementNum <= 16) { 
                            playerData.top16++;
                        }
                        
                        // Posi√ß√£o 17-32: Conta SOMENTE para Top 32 (Se n√£o for Top 16/8)
                        else if (placementNum <= 32) {
                            playerData.top32++;
                        }
                    } 
                    
                    // 3. Tratar coloca√ß√µes com sufixo (Ex: "3rd", "12th")
                    else {
                        // Extrai o n√∫mero da string (Ex: "12th" -> 12)
                        const match = finishLower.match(/^(\d+)/);
                        if (match) {
                            const extractedNum = parseInt(match[1]);
                            
                            // L√≥gica exclusiva com base no n√∫mero extra√≠do
                            if (extractedNum <= 8) {
                                playerData.top8++;
                            } else if (extractedNum <= 16) {
                                playerData.top16++;
                            } else if (extractedNum <= 32) {
                                playerData.top32++;
                            }
                        }
                    }
                    // ------------------------------------

                    // Estat√≠sticas de decks
                    if (deckName) {
                        playerData.deckStats[deckName] = (playerData.deckStats[deckName] || 0) + 1;
                    }

                    // Estat√≠sticas de formatos
                    if (format) {
                        playerData.formatStats[format] = (playerData.formatStats[format] || 0) + 1;
                    }
                }
            });
        }
       function displayResults() {
            if (!playerData) return;

            document.getElementById('player-name').textContent = playerData.username;
            document.getElementById('total-events').textContent = playerData.totalEvents;
            document.getElementById('total-top8').textContent = playerData.top8;
            document.getElementById('total-top16').textContent = playerData.top16;
            document.getElementById('total-5-0').textContent = playerData.fiveO;

            // Preencher tabela de resultados
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';
            
            if (playerData.recentResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 20px; color: #b8b8b8;">
                            Nenhum resultado encontrado
                        </td>
                    </tr>
                `;
            } else {
                playerData.recentResults.forEach(result => {
                    const row = tbody.insertRow();
                    
                    // Colorir a coloca√ß√£o baseado no resultado
                    let placementStyle = '';
                    const finishLower = result.placement.toLowerCase();
                    
                    if (finishLower.includes('1st') || finishLower === '1') {
                        placementStyle = 'color: #FFD700; font-weight: bold;'; // Ouro
                    } else if (finishLower.includes('2nd') || finishLower === '2') {
                        placementStyle = 'color: #C0C0C0; font-weight: bold;'; // Prata
                    } else if (finishLower.includes('3rd') || finishLower === '3') {
                        placementStyle = 'color: #CD7F32; font-weight: bold;'; // Bronze
                    } else if (parseInt(result.placement) <= 8 || finishLower.includes('5-0')) {
                        placementStyle = 'color: #4CAF50; font-weight: bold;'; // Verde para Top 8 / 5-0
                    } else if (parseInt(result.placement) <= 16) {
                        placementStyle = 'color: #66BB6A;'; // Verde claro para Top 16
                    }
                    
                    row.innerHTML = `
                        <td>${result.date}</td>
                        <td>${result.event}</td>
                        <td><strong>${result.deck}</strong></td>
                        <td style="${placementStyle}">${result.placement}</td>
                        <td>${result.format}</td>
                    `;
                });
            }

            // Mostrar estat√≠sticas de decks
            displayDeckStats();
            
            // Mostrar estat√≠sticas de formatos
            displayFormatStats();
            
            showResults();
            showStatus(`‚úÖ ${playerData.totalEvents} resultados encontrados para ${playerData.username}!`, 'success');
        }

        function displayDeckStats() {
            const deckList = document.getElementById('deck-list');
            deckList.innerHTML = '';

            const sortedDecks = Object.entries(playerData.deckStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Top 10 decks

            if (sortedDecks.length === 0) {
                deckList.innerHTML = '<p style="color: #b8b8b8;">Nenhum deck registrado</p>';
                return;
            }

            sortedDecks.forEach(([deck, count]) => {
                const percentage = ((count / playerData.totalEvents) * 100).toFixed(1);
                const deckItem = document.createElement('div');
                deckItem.className = 'deck-stat-item';
                deckItem.innerHTML = `
                    <span class="deck-name">${deck}</span>
                    <span class="deck-count">${count} evento(s) (${percentage}%)</span>
                `;
                deckList.appendChild(deckItem);
            });
        }

        function displayFormatStats() {
            // Adicionar se√ß√£o de formatos se n√£o existir
            let formatSection = document.getElementById('format-stats');
            if (!formatSection) {
                formatSection = document.createElement('section');
                formatSection.id = 'format-stats';
                formatSection.style.display = 'none';
                formatSection.innerHTML = `
                    <h2>üéÆ Formatos Jogados</h2>
                    <div id="format-list"></div>
                `;
                document.querySelector('.container').appendChild(formatSection);
            }

            const formatList = document.getElementById('format-list');
            formatList.innerHTML = '';

            const sortedFormats = Object.entries(playerData.formatStats)
                .sort((a, b) => b[1] - a[1]);

            if (sortedFormats.length === 0) {
                formatSection.style.display = 'none';
                return;
            }

            formatSection.style.display = 'block';

            sortedFormats.forEach(([format, count]) => {
                const percentage = ((count / playerData.totalEvents) * 100).toFixed(1);
                const formatItem = document.createElement('div');
                formatItem.className = 'deck-stat-item';
                formatItem.innerHTML = `
                    <span class="deck-name">${format}</span>
                    <span class="deck-count">${count} evento(s) (${percentage}%)</span>
                `;
                formatList.appendChild(formatItem);
            });
        }

        function showResults() {
            document.getElementById('stats-overview').style.display = 'block';
            document.getElementById('recent-results').style.display = 'block';
            document.getElementById('deck-stats').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('stats-overview').style.display = 'none';
            document.getElementById('recent-results').style.display = 'none';
            document.getElementById('deck-stats').style.display = 'none';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.style.display = 'block';
        }

        // Permitir busca com Enter
        document.getElementById('username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchPlayer();
            }
        });
    </script>

    <style>
        .search-section {
            background-color: #3a3a3a;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 2px solid #4a4a4a;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background-color: #3a3a3a;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #1a4d2e;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(26, 77, 46, 0.4);
            border-color: #4CAF50;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #b8b8b8;
            font-size: 1.1em;
        }

        .deck-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background-color: #3a3a3a;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #4a4a4a;
            transition: all 0.3s ease;
        }

        .deck-stat-item:hover {
            background-color: #4a4a4a;
            border-color: #1a4d2e;
        }

        .deck-name {
            font-weight: bold;
            color: #e8e8e8;
        }

        .deck-count {
            color: #4CAF50;
            font-weight: bold;
        }

        #status {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: bold;
        }

        #status.loading {
            background-color: #3a3a3a;
            color: #b8b8b8;
            border: 2px solid #4a4a4a;
        }

        #status.error {
            background-color: #3a1a1a;
            color: #EF5350;
            border: 2px solid #d32f2f;
        }

        #status.success {
            background-color: #0f2818;
            color: #4CAF50;
            border: 2px solid #25633d;
        }

        #status.warning {
            background-color: #3a2f1a;
            color: #FFB74D;
            border: 2px solid #FFA726;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</body>
</html>
